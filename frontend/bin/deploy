#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )"/.. &> /dev/null && pwd )
TARGET_DIR=$(basename "$SCRIPT_DIR")

[ $(git rev-parse --abbrev-ref HEAD) == "master" ] || { echo "This command must be ran on the master branch" 1>&2; exit 1; }
[ $(basename "`pwd`") == $TARGET_DIR ] || { echo "This command must be ran in the '/frontend' directory" 1>&2; exit 1; }

read -p "This will reset this branch to master and deploy. Continue? (y/N) " -n 1 answer
echo ""

if [ "$answer" == "${answer#[Yy]}" ] || [ "$answer" == "" ]; then
  echo "Operation aborted. No changes were made." 1>&2; 
  exit 2
fi

# reset state to latest
# git fetch origin
# git reset --hard origin/master
echo "Reset HEAD to origin/master"

# build the app
npm run build
echo "Built application pack"

# Clear /docs
rm -rf ../docs
mkdir -p ../docs

# move to /docs
mv build/* ../docs

# commit & push changes
( \
  cd .. && \
  git add . && \
  git commit -am "gh-pages build" && \
  git push origin build \
)

echo "Deployed to github"